<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1~9 Ïπ¥Îìú ÎåÄÏ†Ñ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 10px;
        }

        .header p {
            color: #ccc;
            font-size: 1.1em;
        }

        .game-section {
            display: none;
            background: #111;
            padding: 30px;
            border: 2px solid #333;
        }

        .game-section.active {
            display: block;
        }

        .lobby {
            text-align: center;
        }

        .lobby h3 {
            margin-bottom: 30px;
            color: #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: #222;
            border: 2px solid #444;
            color: #fff;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #00cccc, #0066cc);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .room-info {
            background: #222;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #444;
        }

        .room-code {
            font-size: 1.5em;
            color: #00ffff;
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff;
        }

        .players-list {
            margin: 20px 0;
        }

        .player {
            background: #333;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #555;
        }

        .game-area {
            text-align: center;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: #222;
            border: 2px solid #444;
        }

        .score {
            text-align: center;
        }

        .score h3 {
            color: #00ffff;
            margin-bottom: 10px;
        }

        .score .number {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }

        .round-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .round-info h3 {
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .round-number {
            font-size: 1.5em;
            color: #00ffff;
            font-weight: bold;
        }

        .cards-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .card {
            width: 60px;
            height: 80px;
            background: linear-gradient(45deg, #333, #555);
            border: 2px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .card:hover {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }

        .card.selected {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: #fff;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .current-play {
            margin: 30px 0;
            padding: 20px;
            background: #222;
            border: 2px solid #444;
        }

        .play-cards {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .play-card {
            width: 80px;
            height: 100px;
            background: linear-gradient(45deg, #444, #666);
            border: 2px solid #777;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #fff;
        }

        .play-card.played {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
        }

        .round-result {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border: 2px solid #555;
        }

        .round-result h4 {
            color: #00ffff;
            margin-bottom: 10px;
        }

        .round-result .reason {
            color: #ccc;
            font-size: 1.1em;
        }

        .game-result {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: #222;
            border: 2px solid #444;
        }

        .game-result h2 {
            color: #00ffff;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .final-scores {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 20px 0;
        }

        .final-score {
            text-align: center;
        }

        .final-score h3 {
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .final-score .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ffff;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #333;
            border: 2px solid #555;
            color: #fff;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .message.success {
            background: #2d5a2d;
            border-color: #4a7c4a;
            color: #90ee90;
        }

        .message.error {
            background: #5a2d2d;
            border-color: #7c4a4a;
            color: #ff6b6b;
        }

        .message.hidden {
            opacity: 0;
            transform: translateX(100%);
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .game-info {
                flex-direction: column;
                gap: 20px;
            }
            
            .play-cards {
                gap: 20px;
            }
            
            .final-scores {
                gap: 30px;
            }
        }
    </style>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ 1~9 Ïπ¥Îìú ÎåÄÏ†Ñ</h1>
            <p>Ï†ÑÎûµÏ†Å Ïπ¥Îìú Í≤åÏûÑÏúºÎ°ú ÏäπÎ∂ÄÌïòÏÑ∏Ïöî!</p>
        </div>

        <!-- Î°úÎπÑ ÌôîÎ©¥ -->
        <div id="lobby" class="game-section active">
            <div class="lobby">
                <div id="initialSelection">
                    <h3 style="margin-bottom: 30px; color: #e0e0e0;">Í≤åÏûÑÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî!</h3>
                    <button id="showCreateRoom" class="btn" style="margin: 10px;">ÏÉà Î∞© ÎßåÎì§Í∏∞</button>
                    <button id="showJoinRoom" class="btn" style="margin: 10px;">Ï¥àÎåÄÏΩîÎìú ÏûÖÎ†•ÌïòÍ∏∞</button>
                    <button id="showAIGame" class="btn" style="margin: 10px; background: linear-gradient(45deg, #ff6b6b, #ee5a24);">ü§ñ AIÏôÄ ÎåÄÏ†Ñ</button>
                </div>

                <div id="createRoomForm" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #e0e0e0;">ÏÉà Î∞© ÎßåÎì§Í∏∞</h3>
                    <div class="form-group">
                        <label for="createPlayerName">ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ:</label>
                        <input type="text" id="createPlayerName" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <button id="createRoomBtn" class="btn">Î∞© ÎßåÎì§Í∏∞</button>
                    <button id="backToSelection" class="btn" style="background: #666;">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                </div>

                <div id="joinRoomForm" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #e0e0e0;">Î∞© ÏûÖÏû•ÌïòÍ∏∞</h3>
                    <div class="form-group">
                        <label for="joinPlayerName">ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ:</label>
                        <input type="text" id="joinPlayerName" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <div class="form-group">
                        <label for="roomCode">Î∞© ÏΩîÎìú:</label>
                        <input type="text" id="roomCode" placeholder="Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="text-transform: uppercase;">
                    </div>
                    <button id="joinRoomBtn" class="btn">Î∞© ÏûÖÏû•</button>
                    <button id="backToSelection2" class="btn" style="background: #666;">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                </div>

                <div id="aiGameForm" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #e0e0e0;">AIÏôÄ ÎåÄÏ†Ñ</h3>
                    <div class="form-group">
                        <label for="aiPlayerName">ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ:</label>
                        <input type="text" id="aiPlayerName" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>
                    <button id="createAIGameBtn" class="btn">AI Í≤åÏûÑ ÏãúÏûë</button>
                    <button id="backToSelection3" class="btn" style="background: #666;">ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                </div>
            </div>
        </div>

        <!-- ÎåÄÍ∏∞ ÌôîÎ©¥ -->
        <div id="waiting" class="game-section">
            <div class="lobby">
                <h3 style="margin-bottom: 20px; color: #e0e0e0;">Í≤åÏûÑ ÎåÄÍ∏∞ Ï§ë...</h3>
                <div class="room-info">
                    <h4 style="margin-bottom: 10px; color: #ccc;">Î∞© ÏΩîÎìú:</h4>
                    <div class="room-code" id="displayRoomCode">-</div>
                </div>
                <div class="players-list">
                    <h4 style="margin-bottom: 10px; color: #ccc;">ÌîåÎ†àÏù¥Ïñ¥:</h4>
                    <div id="playersList"></div>
                </div>
                <button id="startGameBtn" class="btn" style="display: none;">Í≤åÏûÑ ÏãúÏûë</button>
            </div>
        </div>

        <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
        <div id="game" class="game-section">
            <div class="game-area">
                <div class="game-info">
                    <div class="score">
                        <h3>ÌîåÎ†àÏù¥Ïñ¥ 1</h3>
                        <div class="number" id="player1Score">0</div>
                    </div>
                    <div class="round-info">
                        <h3>ÎùºÏö¥Îìú</h3>
                        <div class="round-number" id="currentRound">1</div>
                    </div>
                    <div class="score">
                        <h3>ÌîåÎ†àÏù¥Ïñ¥ 2</h3>
                        <div class="number" id="player2Score">0</div>
                    </div>
                </div>

                <div class="round-info">
                    <h3>ÌòÑÏû¨ ÌîåÎ†àÏù¥</h3>
                    <div class="current-play">
                        <div class="play-cards">
                            <div class="play-card" id="player1Card">-</div>
                            <div class="play-card" id="player2Card">-</div>
                        </div>
                    </div>
                </div>

                <div class="round-result" id="roundResult" style="display: none;">
                    <h4>ÎùºÏö¥Îìú Í≤∞Í≥º</h4>
                    <div class="reason" id="roundReason"></div>
                </div>

                <div class="cards-container" id="cardsContainer"></div>
            </div>
        </div>

        <!-- Í≤åÏûÑ Ï¢ÖÎ£å ÌôîÎ©¥ -->
        <div id="finished" class="game-section">
            <div class="game-result">
                <h2 id="gameResultTitle">Í≤åÏûÑ Ï¢ÖÎ£å!</h2>
                <div class="final-scores">
                    <div class="final-score">
                        <h3>ÌîåÎ†àÏù¥Ïñ¥ 1</h3>
                        <div class="number" id="finalPlayer1Score">0</div>
                    </div>
                    <div class="final-score">
                        <h3>ÌîåÎ†àÏù¥Ïñ¥ 2</h3>
                        <div class="number" id="finalPlayer2Score">0</div>
                    </div>
                </div>
                <button id="newGameBtn" class="btn">ÏÉà Í≤åÏûÑ</button>
                <button id="backToLobbyBtn" class="btn" style="background: #666;">Î°úÎπÑÎ°ú</button>
            </div>
        </div>

        <!-- Î©îÏãúÏßÄ ÌëúÏãú ÏòÅÏó≠ -->
        <div id="messageArea"></div>
    </div>

    <script>
        class GameClient {
            constructor() {
                this.playerId = null;
                this.playerName = null;
                this.roomId = null;
                this.currentPlayer = null;
                this.gameState = 'lobby';
                this.selectedCard = null;
                this.ably = null;
                this.channel = null;
                
                this.initializeElements();
                this.attachEventListeners();
                this.showScreen('lobby');
            }
            
            initializeElements() {
                this.elements = {
                    // ÌôîÎ©¥Îì§
                    lobby: document.getElementById('lobby'),
                    waiting: document.getElementById('waiting'),
                    game: document.getElementById('game'),
                    finished: document.getElementById('finished'),
                    
                    // Î°úÎπÑ ÏöîÏÜåÎì§
                    initialSelection: document.getElementById('initialSelection'),
                    createRoomForm: document.getElementById('createRoomForm'),
                    joinRoomForm: document.getElementById('joinRoomForm'),
                    aiGameForm: document.getElementById('aiGameForm'),
                    
                    // ÏûÖÎ†• ÌïÑÎìúÎì§
                    createPlayerName: document.getElementById('createPlayerName'),
                    joinPlayerName: document.getElementById('joinPlayerName'),
                    aiPlayerName: document.getElementById('aiPlayerName'),
                    roomCode: document.getElementById('roomCode'),
                    
                    // Î≤ÑÌäºÎì§
                    showCreateRoom: document.getElementById('showCreateRoom'),
                    showJoinRoom: document.getElementById('showJoinRoom'),
                    showAIGame: document.getElementById('showAIGame'),
                    createRoomBtn: document.getElementById('createRoomBtn'),
                    joinRoomBtn: document.getElementById('joinRoomBtn'),
                    createAIGameBtn: document.getElementById('createAIGameBtn'),
                    backToSelection: document.getElementById('backToSelection'),
                    backToSelection2: document.getElementById('backToSelection2'),
                    backToSelection3: document.getElementById('backToSelection3'),
                    startGameBtn: document.getElementById('startGameBtn'),
                    newGameBtn: document.getElementById('newGameBtn'),
                    backToLobbyBtn: document.getElementById('backToLobbyBtn'),
                    
                    // Í≤åÏûÑ ÏöîÏÜåÎì§
                    displayRoomCode: document.getElementById('displayRoomCode'),
                    playersList: document.getElementById('playersList'),
                    player1Score: document.getElementById('player1Score'),
                    player2Score: document.getElementById('player2Score'),
                    currentRound: document.getElementById('currentRound'),
                    player1Card: document.getElementById('player1Card'),
                    player2Card: document.getElementById('player2Card'),
                    roundResult: document.getElementById('roundResult'),
                    roundReason: document.getElementById('roundReason'),
                    cardsContainer: document.getElementById('cardsContainer'),
                    gameResultTitle: document.getElementById('gameResultTitle'),
                    finalPlayer1Score: document.getElementById('finalPlayer1Score'),
                    finalPlayer2Score: document.getElementById('finalPlayer2Score'),
                    messageArea: document.getElementById('messageArea')
                };
            }
            
            attachEventListeners() {
                // Î°úÎπÑ Î≤ÑÌäºÎì§
                this.elements.showCreateRoom.addEventListener('click', () => this.showCreateRoomForm());
                this.elements.showJoinRoom.addEventListener('click', () => this.showJoinRoomForm());
                this.elements.showAIGame.addEventListener('click', () => this.showAIGameForm());
                
                // Ìèº Î≤ÑÌäºÎì§
                this.elements.createRoomBtn.addEventListener('click', () => this.createRoom());
                this.elements.joinRoomBtn.addEventListener('click', () => this.joinRoom());
                this.elements.createAIGameBtn.addEventListener('click', () => this.createAIGame());
                
                // ÎèåÏïÑÍ∞ÄÍ∏∞ Î≤ÑÌäºÎì§
                this.elements.backToSelection.addEventListener('click', () => this.showInitialSelection());
                this.elements.backToSelection2.addEventListener('click', () => this.showInitialSelection());
                this.elements.backToSelection3.addEventListener('click', () => this.showInitialSelection());
                
                // Í≤åÏûÑ Î≤ÑÌäºÎì§
                this.elements.startGameBtn.addEventListener('click', () => this.startGame());
                this.elements.newGameBtn.addEventListener('click', () => this.newGame());
                this.elements.backToLobbyBtn.addEventListener('click', () => this.backToLobby());
                
                // ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
                this.elements.createPlayerName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createRoom();
                });
                this.elements.joinPlayerName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinRoom();
                });
                this.elements.roomCode.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinRoom();
                });
                this.elements.aiPlayerName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createAIGame();
                });
            }
            
            async connectAbly() {
                console.log('Ably Ïó∞Í≤∞ ÏãúÎèÑ...');
                
                try {
                    // Ably ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî (Í∞ÑÎã®Ìïú Î∞©Ïãù)
                    this.ably = new Ably.Realtime("qvbjOA.EbbZ6g:lHGCOz5aSbkalenzwn2qRImwpxQul9BKZo3NQmbKw6g");
                    
                    this.ably.connection.once('connected', () => {
                        console.log('Ably Ïó∞Í≤∞Îê®');
                        this.showMessage('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§', 'success');
                    });
                    
                    this.ably.connection.on('disconnected', () => {
                        console.log('Ably Ïó∞Í≤∞ Ï¢ÖÎ£å');
                        this.showMessage('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§', 'error');
                    });
                    
                    this.ably.connection.on('failed', (error) => {
                        console.error('Ably Ïó∞Í≤∞ Ïã§Ìå®:', error);
                        this.showMessage('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®', 'error');
                    });
                    
                } catch (error) {
                    console.error('Ably Ïó∞Í≤∞ Ïò§Î•ò:', error);
                    this.showMessage('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•ò', 'error');
                }
            }
            
            async subscribeToRoom(roomId) {
                if (!this.ably) return;
                
                this.channel = this.ably.channels.get(`room:${roomId}`);
                
                await this.channel.subscribe('game-event', (message) => {
                    const data = message.data;
                    
                    // ÏûêÏã†ÏóêÍ≤å Î≥¥ÎÇ∏ Î©îÏãúÏßÄÎßå Ï≤òÎ¶¨
                    if (data.targetPlayer === this.playerId) {
                        this.handleMessage(data);
                    }
                });
            }
            
            handleMessage(data) {
                console.log('Î∞õÏùÄ Î©îÏãúÏßÄ:', data);
                
                switch (data.type) {
                    case 'room_created':
                        this.playerId = data.playerId || this.generatePlayerId();
                        this.roomId = data.roomId;
                        this.currentPlayer = data.player;
                        this.showScreen('waiting');
                        this.updateWaitingDisplay(data.room);
                        this.showMessage('Î∞©Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
                        break;
                        
                    case 'ai_game_started':
                        console.log('AI Í≤åÏûÑ ÏãúÏûë Îç∞Ïù¥ÌÑ∞:', data);
                        this.playerId = data.playerId || this.generatePlayerId();
                        this.roomId = data.roomId;
                        this.currentPlayer = data.player;
                        this.showScreen('game');
                        console.log('ÌòÑÏû¨ ÌîåÎ†àÏù¥Ïñ¥:', this.currentPlayer);
                        console.log('Î∞© Îç∞Ïù¥ÌÑ∞:', data.room);
                        this.updateGameDisplay(data.room);
                        this.showMessage('AIÏôÄÏùò Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
                        setTimeout(() => {
                            console.log('Ïπ¥Îìú Í∞ïÏ†ú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÎèÑ');
                            this.updateCardsDisplay(data.room.cards);
                        }, 100);
                        break;
                        
                    case 'joined_room':
                        this.playerId = data.playerId || this.generatePlayerId();
                        this.roomId = data.roomId;
                        this.currentPlayer = data.player;
                        this.showScreen('waiting');
                        this.updateWaitingDisplay(data.room);
                        this.showMessage('Î∞©Ïóê ÏûÖÏû•ÌñàÏäµÎãàÎã§!', 'success');
                        break;
                        
                    case 'player_joined':
                        this.updateWaitingDisplay(data.room);
                        this.showMessage(`${data.player.name}ÎãòÏù¥ ÏûÖÏû•ÌñàÏäµÎãàÎã§!`, 'success');
                        break;
                        
                    case 'game_started':
                        this.showScreen('game');
                        this.updateGameDisplay(data.room);
                        this.showMessage('Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
                        break;
                        
                    case 'card_played':
                        this.updateCurrentPlay(data.currentPlay);
                        this.updateCardsDisplay(data.cards);
                        if (data.playerId === this.playerId) {
                            this.selectedCard = null;
                        }
                        break;
                        
                    case 'round_result':
                        this.updateScores(data.scores);
                        this.updateRound(data.currentRound);
                        this.showRoundResult(data.result);
                        break;
                        
                    case 'game_finished':
                        this.showScreen('finished');
                        this.updateGameResult(data.result);
                        this.showMessage('Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                        break;
                        
                    case 'error':
                        this.showMessage(data.message, 'error');
                        break;
                }
            }
            
            showScreen(screen) {
                document.querySelectorAll('.game-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(screen).classList.add('active');
                this.gameState = screen;
            }
            
            showInitialSelection() {
                this.elements.initialSelection.style.display = 'block';
                this.elements.createRoomForm.style.display = 'none';
                this.elements.joinRoomForm.style.display = 'none';
                this.elements.aiGameForm.style.display = 'none';
            }
            
            showCreateRoomForm() {
                this.elements.initialSelection.style.display = 'none';
                this.elements.createRoomForm.style.display = 'block';
                this.elements.joinRoomForm.style.display = 'none';
                this.elements.aiGameForm.style.display = 'none';
                this.elements.createPlayerName.focus();
            }
            
            showJoinRoomForm() {
                this.elements.initialSelection.style.display = 'none';
                this.elements.createRoomForm.style.display = 'none';
                this.elements.joinRoomForm.style.display = 'block';
                this.elements.aiGameForm.style.display = 'none';
                this.elements.joinPlayerName.focus();
            }
            
            showAIGameForm() {
                this.elements.initialSelection.style.display = 'none';
                this.elements.createRoomForm.style.display = 'none';
                this.elements.joinRoomForm.style.display = 'none';
                this.elements.aiGameForm.style.display = 'block';
                this.elements.aiPlayerName.focus();
            }
            
            async createRoom() {
                const playerName = this.elements.createPlayerName.value.trim();
                if (!playerName) {
                    this.showMessage('ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                    return;
                }
                
                this.playerName = playerName;
                this.playerId = this.generatePlayerId();
                await this.connectAbly();
                
                try {
                    const response = await fetch('/game/create_room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            playerId: this.playerId,
                            playerName: playerName
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.roomId = data.roomId;
                        this.currentPlayer = data.player;
                        this.subscribeToRoom(this.roomId);
                        this.handleMessage(data);
                    }
                } catch (error) {
                    console.error('Î∞© ÏÉùÏÑ± Ïò§Î•ò:', error);
                    this.showMessage('Î∞© ÏÉùÏÑ± Ïã§Ìå®', 'error');
                }
            }
            
            async joinRoom() {
                const playerName = this.elements.joinPlayerName.value.trim();
                const roomCode = this.elements.roomCode.value.trim().toUpperCase();
                
                if (!playerName || !roomCode) {
                    this.showMessage('Ïù¥Î¶ÑÍ≥º Î∞© ÏΩîÎìúÎ•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                    return;
                }
                
                this.playerName = playerName;
                this.playerId = this.generatePlayerId();
                this.roomId = roomCode;
                await this.connectAbly();
                
                try {
                    const response = await fetch('/game/join_room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomId: roomCode,
                            playerId: this.playerId,
                            playerName: playerName
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.currentPlayer = data.player;
                        this.subscribeToRoom(this.roomId);
                        this.handleMessage(data);
                    } else {
                        this.showMessage(data.message || 'Î∞© ÏûÖÏû• Ïã§Ìå®', 'error');
                    }
                } catch (error) {
                    console.error('Î∞© ÏûÖÏû• Ïò§Î•ò:', error);
                    this.showMessage('Î∞© ÏûÖÏû• Ïã§Ìå®', 'error');
                }
            }
            
            async createAIGame() {
                const playerName = this.elements.aiPlayerName.value.trim();
                if (!playerName) {
                    this.showMessage('ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                    return;
                }
                
                this.playerName = playerName;
                this.playerId = this.generatePlayerId();
                await this.connectAbly();
                
                try {
                    const response = await fetch('/game/create_ai_room', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            playerId: this.playerId,
                            playerName: playerName
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.roomId = data.roomId;
                        this.currentPlayer = data.player;
                        this.subscribeToRoom(this.roomId);
                        this.handleMessage(data);
                    }
                } catch (error) {
                    console.error('AI Í≤åÏûÑ ÏÉùÏÑ± Ïò§Î•ò:', error);
                    this.showMessage('AI Í≤åÏûÑ ÏÉùÏÑ± Ïã§Ìå®', 'error');
                }
            }
            
            async startGame() {
                try {
                    const response = await fetch('/game/start_game', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomId: this.roomId
                        })
                    });
                    const data = await response.json();
                    if (!data.success) {
                        this.showMessage('Í≤åÏûÑ ÏãúÏûë Ïã§Ìå®', 'error');
                    }
                } catch (error) {
                    console.error('Í≤åÏûÑ ÏãúÏûë Ïò§Î•ò:', error);
                    this.showMessage('Í≤åÏûÑ ÏãúÏûë Ïã§Ìå®', 'error');
                }
            }
            
            async playCard(card) {
                if (this.selectedCard) return;
                
                this.selectedCard = card;
                try {
                    const response = await fetch('/game/play_card', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomId: this.roomId,
                            playerId: this.playerId,
                            card: card
                        })
                    });
                    const data = await response.json();
                    if (!data.success) {
                        this.showMessage('Ïπ¥Îìú ÌîåÎ†àÏù¥ Ïã§Ìå®', 'error');
                        this.selectedCard = null;
                    }
                } catch (error) {
                    console.error('Ïπ¥Îìú ÌîåÎ†àÏù¥ Ïò§Î•ò:', error);
                    this.showMessage('Ïπ¥Îìú ÌîåÎ†àÏù¥ Ïã§Ìå®', 'error');
                    this.selectedCard = null;
                }
            }
            
            updateWaitingDisplay(room) {
                this.elements.displayRoomCode.textContent = room.id || this.roomId;
                
                const playersList = this.elements.playersList;
                playersList.innerHTML = '';
                
                room.players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player';
                    playerDiv.textContent = `${player.name} (${player.position})`;
                    playersList.appendChild(playerDiv);
                });
                
                // Í≤åÏûÑ ÏãúÏûë Î≤ÑÌäº ÌëúÏãú (Î∞©Ïû•Îßå)
                if (room.players.length >= 2 && !room.isAIGame) {
                    this.elements.startGameBtn.style.display = 'block';
                } else {
                    this.elements.startGameBtn.style.display = 'none';
                }
            }
            
            updateGameDisplay(room) {
                this.updateScores(room.scores);
                this.updateRound(room.currentRound);
                this.updateCurrentPlay(room.currentPlay);
                this.updateCardsDisplay(room.cards);
            }
            
            updateScores(scores) {
                this.elements.player1Score.textContent = scores.player1;
                this.elements.player2Score.textContent = scores.player2;
            }
            
            updateRound(round) {
                this.elements.currentRound.textContent = round;
            }
            
            updateCurrentPlay(currentPlay) {
                this.elements.player1Card.textContent = currentPlay.player1 || '-';
                this.elements.player2Card.textContent = currentPlay.player2 || '-';
                
                this.elements.player1Card.className = 'play-card' + (currentPlay.player1 ? ' played' : '');
                this.elements.player2Card.className = 'play-card' + (currentPlay.player2 ? ' played' : '');
            }
            
            updateCardsDisplay(cards) {
                console.log('updateCardsDisplay Ìò∏Ï∂úÎê®:', { cards, currentPlayer: this.currentPlayer });
                const container = this.elements.cardsContainer;
                container.innerHTML = '';
                const playerPosition = this.currentPlayer?.position;
                console.log('ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò:', playerPosition);
                if (!playerPosition) {
                    console.log('ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπòÍ∞Ä ÏóÜÏùå');
                    return;
                }
                if (!cards || !cards[playerPosition]) {
                    console.log('Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùå:', { cards, playerPosition });
                    return;
                }
                console.log('Ïπ¥Îìú ÌëúÏãú ÏãúÏûë:', { playerPosition, availableCards: cards[playerPosition] });
                cards[playerPosition].forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card';
                    cardElement.textContent = card;
                    if (this.selectedCard === card) {
                        cardElement.classList.add('selected');
                    }
                    cardElement.addEventListener('click', () => {
                        if (!this.selectedCard && this.gameState === 'playing') {
                            this.playCard(card);
                        }
                    });
                    container.appendChild(cardElement);
                });
                console.log('Ïπ¥Îìú ÌëúÏãú ÏôÑÎ£å, Ï¥ù Ïπ¥Îìú Ïàò:', cards[playerPosition].length);
            }
            
            showRoundResult(result) {
                this.elements.roundResult.style.display = 'block';
                this.elements.roundReason.textContent = `${result.player1Card} vs ${result.player2Card} - ${result.reason}`;
                
                setTimeout(() => {
                    this.elements.roundResult.style.display = 'none';
                }, 3000);
            }
            
            updateGameResult(result) {
                this.elements.finalPlayer1Score.textContent = result.scores.player1;
                this.elements.finalPlayer2Score.textContent = result.scores.player2;
                
                if (result.winner === 'tie') {
                    this.elements.gameResultTitle.textContent = 'Î¨¥ÏäπÎ∂Ä!';
                } else if (result.winner === 'player1') {
                    this.elements.gameResultTitle.textContent = 'ÌîåÎ†àÏù¥Ïñ¥ 1 ÏäπÎ¶¨!';
                } else {
                    this.elements.gameResultTitle.textContent = 'ÌîåÎ†àÏù¥Ïñ¥ 2 ÏäπÎ¶¨!';
                }
            }
            
            newGame() {
                this.startGame();
            }
            
            backToLobby() {
                this.resetGame();
            }
            
            resetGame() {
                if (this.ably) {
                    this.ably.close();
                    this.ably = null;
                }
                if (this.channel) {
                    this.channel.unsubscribe();
                    this.channel = null;
                }
                
                this.playerId = null;
                this.playerName = null;
                this.roomId = null;
                this.currentPlayer = null;
                this.selectedCard = null;
                this.gameState = 'lobby';
                
                this.elements.createPlayerName.value = '';
                this.elements.joinPlayerName.value = '';
                this.elements.aiPlayerName.value = '';
                this.elements.roomCode.value = '';
                this.showInitialSelection();
            }
            
            generatePlayerId() {
                return 'player_' + Math.random().toString(36).substr(2, 9);
            }
            
            showMessage(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;
                
                this.elements.messageArea.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }, 3000);
            }
        }
        
        const gameClient = new GameClient();
    </script>
</body>
</html>
